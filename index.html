<!doctype html>
<html>
<head>
    <title>Open Budget - Expenditures</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="libs/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="libs/keen_io/keen-dashboards.css">
    <link rel="stylesheet" href="libs/dc.js/dc.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        /* Width for all dc.js charts */
        .svg-container { width: 100%; }

        /* Color for side panel button and selected accordion */
        .w3-darkblue, .w3-darkblue:hover {
            color: #fff!important;
            background-color:rgb(63, 75, 88)!important;
        }

        /* Hide x and y axis for bubble chart */
        #bubble-chart svg g g.axis.x { display: none; }
        #bubble-chart svg g g.axis.y { display: none; }
        #bubble-chart text { font-size: 1.17em; }

        /* Lighter Color for Row Text */
        #row-chart > svg > g > g.row > text { fill: rgb(82, 80, 80); }

        /* Minimizes stroke width for selected pie slice */
        #sun-burst g.pie-slice.selected path { stroke-width: 0; }

        /* For Data Table td cells */
        #data-table td { font-size: 0.9em; }

        /* For Options Text */
        #sel-departments option,
        #sel-years option,
        #sel-fund-types option,
        #sel-branch-programs option { font-size: 0.88em; }

        #DataTables_Table_0_wrapper { margin-top: 0.5em; }
    </style>
</head>
<body class="application">
    <div class="w3-sidebar w3-bar-block w3-card w3-animate-left" style="display:none" id="mySidebar">
        <button class="w3-bar-item w3-button w3-large"onclick="w3_close()">Close &times;</button>
        <a href="http://budget.edmonton.ca/#!/year/default" target="_blank" class="w3-bar-item w3-button">Open Budget</a>
        <div class="w3-bar-item w3-button" onclick="myAccFunc('demoAcc')">Departments <i class="fa fa-caret-down"></i></div>
        <div id="demoAcc" class="w3-hide w3-white w3-card-4">
            <div class="w3-bar-item w3-button" id="sel-departments"></div>
        </div>
        <div class="w3-bar-item w3-button" onclick="myAccFunc('demoAcc2')">Years <i class="fa fa-caret-down"></i></div>
        <div id="demoAcc2" class="w3-hide w3-white w3-card-4">
            <div class="w3-bar-item w3-button" id="sel-years"></div>
        </div>
        <div class="w3-bar-item w3-button" onclick="myAccFunc('demoAcc3')">Fund Types <i class="fa fa-caret-down"></i></div>
        <div id="demoAcc3" class="w3-hide w3-white w3-card-4">
            <div class="w3-bar-item w3-button" id="sel-fund-types"></div>
        </div>
        <div class="w3-bar-item w3-button" onclick="myAccFunc('demoAcc4')">Branches & Programs <i class="fa fa-caret-down"></i></div>
        <div id="demoAcc4" class="w3-hide w3-white w3-card-4">
            <div class="w3-bar-item w3-button" id="sel-branch-programs"></div>
        </div>
    </div>
    <!-- Makes Row Responsive -->
    <div id="main" class="container-fluid">
        <!-- Navbar -->
        <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button id="openNav" class="w3-button w3-darkblue w3-xlarge" onclick="w3_open()">&#9776; Open Budget Expenditures - City of Edmonton</button>
                </div>
            </div>
        </div>
        <div class="row">
            <!-- column 1 for row -->
            <div class="col-md-3">
                <!-- row in column 1 -->
                <div class="row">
                    <!-- Row Chart -->
                    <div class="col-md-12">
                        <div class="chart-wrapper">
                            <div class="chart-stage">
                                <div id="row-chart" class="svg-container">
                                    <div class="chart-title">
                                        <span>Departments</span>
                                        <span>
                                            <a class="reset" style="display:none; color: rgb(36, 118, 179);" href="javascript:row.filterAll(); dc.redrawAll();">
                                                Reset
                                            </a>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>                    
                </div>
            </div>
            <!-- column 2 for row -->
            <div class="col-md-5">
                <!-- row in column 2 -->
                <div class="row">
                    <!-- Bar Chart -->
                    <div class="col-md-12">
                        <div class="chart-wrapper">
                            <div class="chart-stage">
                                <div id="bar-chart" class="svg-container">
                                    <div class="chart-title">
                                        <span>Years</span>
                                        <span>
                                            <a class="reset" style="display:none; color: rgb(36, 118, 179);" href="javascript:bar.filterAll(); dc.redrawAll();">
                                                Reset
                                            </a>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Bubble Chart -->
                    <div class="col-md-12">
                        <div class="chart-wrapper">
                            <div class="chart-stage">
                                <div id="bubble-chart" class="svg-container">
                                    <div class="chart-title">
                                        <span>Fund Types</span>
                                        <span>
                                            <a class="reset" style="display:none; color: rgb(36, 118, 179);" href="javascript:bubble.filterAll(); dc.redrawAll();">
                                                Reset
                                            </a>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>                      
                </div>
            </div>
            <!-- column 3 for row -->
            <div class="col-md-4">
                <!-- row in column 3 -->
                <div class="row">
                    <!-- Sunburst -->
                    <div class="col-md-12">
                        <div class="chart-wrapper">
                            <div class="chart-stage">
                                <div id="sun-burst" class="svg-container">
                                    <div class="chart-title">
                                        <span>Branches & Programs</span>
                                        <span>
                                            <a class="reset" style="display:none; color: rgb(36, 118, 179);" href="javascript:sunBurst.filterAll(); dc.redrawAll();">
                                                Reset
                                            </a>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- column 4 for row -->
            <div class="col-md-12">
                <!-- row in column 4 -->
                <div class="row">
                    <!-- Data Table -->
                    <div class="col-md-12">
                        <div class="chart-wrapper">
                            <div class="chart-stage">
                                <div id="data-table">
                                    <div class="chart-title">
                                        <span>Expenditure Table - </span>
                                        <span id="records-count"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="libs/d3/d3.min.js"></script>
    <script src="libs/crossfilter/crossfilter.js"></script>
    <script src="libs/jquery/jquery.js"></script>
    <script src="libs/dataTables/jquery.dataTables.min.js"></script>
    <script src="libs/dc.js/dc.min.js"></script>
    <script src="libs/dc.js/dc.datatables.js"></script>
    <script>
        const log = console.log;
        const rowColors = 
        [
            "#b3d485","#da84ec","#bbe532","#ef85c0",
            "#6fda4c","#afaae6","#dfc32b","#73c3e2",
            "#ec9228","#74d4cb","#f48658","#5cdca9",
            "#ec9084","#6bd77d","#e0a2b5","#c6d04e",
            "#bbc2cc","#dbad4d","#9dcfa7","#d6b46f",
            "#b6cf64","#ccc2a7","#d6ba86"
        ];

        //for loading files
        const PromiseWrapper = function(d) {
            return new Promise(function(resolve) {
                d3.json(d, function(p) { resolve(p); });
            });
        };

        //dc.js modules
        const sunBurst = dc.sunburstChart("#sun-burst");
        const bar = dc.barChart("#bar-chart");
        const bubble = dc.bubbleChart("#bubble-chart");
        const row = dc.rowChart("#row-chart");
        const table = dc_datatables.datatable("#data-table");
        const rowSels = dc.selectMenu("#sel-departments");
        const barSels = dc.selectMenu("#sel-years");
        const bubbleSels = dc.selectMenu("#sel-fund-types");
        const sunBurstSels = dc.selectMenu("#sel-branch-programs");
        const recordCounter = dc.dataCount("#records-count");

        //load data json files
        Promise
            .all([
                PromiseWrapper("json-files/expenditures2(May-22-2018).json"),
                PromiseWrapper("json-files/sunburst-colors.json")
            ])
            .then((resolve) => viz(resolve[0], resolve[1]));

        function viz(response, sunburstColors) {

            //color scales
            const departments = [...new Set(response.map(d => d.department))];
            const branches = [...new Set(response.map(d => d.branch))];
            const programs = [...new Set(response.map(d => d.program))];
            const branProgs = [branches, programs].reduce((acc, curArr) => acc.concat(curArr),[]);
            const sunBurstColorScale = d3.scaleOrdinal().domain(branProgs).range(sunburstColors);
            const rowColorScale = d3.scaleOrdinal().domain(departments).range(rowColors);

            let ndx = crossfilter(response);

            //dimensions
            let branProgDim = ndx.dimension(d => [d["branch"], d["program"]]);
            let departDim = ndx.dimension(d => d["department"]);
            let fundTypeDim = ndx.dimension(d => d["fund_type"]);
            let budgetYrDim = ndx.dimension(d => d["budget_year"]);

            //groups
            let branProgGrp = branProgDim.group().reduceSum(d => d["budget"]);
            let departGrp = departDim.group().reduceSum(d => d["budget"]);
            let fundTypeGrp = fundTypeDim.group().reduceSum(d => d["budget"]);
            let budgetYrGrp = budgetYrDim.group().reduceSum(d => d["budget"]);
            let sumofAllExpends = ndx.groupAll().reduceSum(d => d["budget"]);

            //for bubble attributes
            const fundTypeValues = fundTypeGrp.all().map(d => d.value).sort((a, b) => a - b);
            const fundTypeKeys = fundTypeGrp.all().map(d => d).sort((a, b) => b.value - a.value).map(d => d.key);
            const fundTypeMinMax = [fundTypeValues[0], fundTypeValues[fundTypeValues.length - 1]];

            //title, multiple, order assignment, and customFilter func for each select menu
            const selcts = [rowSels, barSels, bubbleSels, sunBurstSels].forEach(sel => {
                    sel
                        .title(d => `${d.key}: $${d.value.toLocaleString()}`)
                        .multiple(true)
                        .order((a, b) => b.value > a.value ? 1 : a.value > b.value ? -1 : 0)
                        .on("filtered." + sel.chartID(), sumUpdater);
                });

            //title, viewBoxResizing, and customFilter func for each chart
            const charts = [row, bar, bubble, sunBurst].forEach(chart => {
                    chart
                        .title(d => `${d.key}: $${d.value.toLocaleString()}`)
                        .useViewBoxResizing(true)
                        .on("filtered." + chart.chartID(), sumUpdater);
            });

            recordCounter.dimension(ndx)
                .group(ndx.groupAll())
                .html({
                    some: '<strong>%filter-count</strong> selected out of <strong>%total-count</strong> records.',
                    all: 'All records selected. Please click on the chart(s) to apply filters.'
                });

            row
                .height(row.width() * 1.215)
                .dimension(departDim)
                .elasticX(true)
                .colors(rowColorScale)
                .colorAccessor((d, i) => d.key)
                .group(departGrp);
            row.xAxis().ticks(4); 

            bar
                .height(bar.width() * 0.315)
                .margins({
                    top: bar.width() * 0.017, bottom: bar.width() * 0.033,
                    right: bar.width() * 0.033, left: bar.width() * 0.134
                })
                .dimension(budgetYrDim)
                .elasticY(true)
                .group(budgetYrGrp)
                .x(d3.scaleBand())
                .barPadding(0.07)
                .outerPadding(0.1)
                .xUnits(dc.units.ordinal);
            bar.yAxis().ticks(4); 
            
            bubble
                .height(bubble.width() * 0.314)
                .margins(
                    {
                        top:bubble.width() * 0.159, bottom: bubble.width() * 0.026,
                        left:-(bubble.width() * 0.093), right: bubble.width() * 0.12
                    }
                )
                .dimension(fundTypeDim)
                .elasticY(true)
                .label(d => `${d.key}: $${d.value.toLocaleString()}`)
                .group(fundTypeGrp)
                .clipPadding(10000)
                .colors(["#fbb4ae", "#b3cde3", "#ccebc5", "#decbe4"])
                .colorDomain([1, fundTypeKeys.length])
                .colorAccessor((d, i) => i + 1)
                .keyAccessor((d, i) => fundTypeKeys.indexOf(d.key) + 1)
                .valueAccessor(d => d.value)
                .radiusValueAccessor(d => d.value)
                .maxBubbleRelativeSize(0.016)
                .x(d3.scaleLinear().domain([0, 4]))
                .r(d3.scaleLinear().domain([0, fundTypeMinMax[0]]));

            sunBurst
                .height(sunBurst.width() * 0.894)
                .label(d => d.budget, false)
                .dimension(branProgDim)
                .group(branProgGrp)
                .colors(sunBurstColorScale)
                .colorAccessor((d, i) => d.key);

            table
                .dimension(budgetYrDim )
                .group(d => d["budget"])
                .size(10)
                .columns([
                    {
                        label: "Department",
                        format: d => d["department"]
                    },
                    {
                        label: "Branch",
                        format: d => d["branch"]
                    },
                    {
                        label: "Program",
                        format: d => d["program"]
                    },
                    {
                        label: "Fund Type",
                        format: d => d["fund_type"]
                    },
                    {
                        label: "Budget Year",
                        format: d => d["budget_year"]
                    },
                    {
                        label: "Budget",
                        format: d => `$${d["budget"].toLocaleString()}`
                    }
                ]);

            rowSels
                .dimension(departDim)
                .group(departGrp)
                .numberVisible(11);   

            barSels
                .dimension(budgetYrDim)
                .group(budgetYrGrp)
                .numberVisible(5); 

            bubbleSels
                .dimension(fundTypeDim)
                .group(fundTypeGrp)
                .numberVisible(6);  

            sunBurstSels
                .dimension(branProgDim)
                .group(branProgGrp)
                .numberVisible(11);   

            dc.renderAll();

            const texts = [
                    {
                        id:"stats-title", 
                        x: bubble.width() * 0.5, 
                        y: bubble.height() * 0.5, 
                        content: "Sum:", 
                        "text-anchor": "start",
                        "font-size": Math.round(bubble.height() * 0.08, 1)
                    },
                    {
                        id: "sum",
                        x: bubble.width() * 0.58,
                        y: bubble.height() * 0.5, 
                        content: "$"+sumofAllExpends.value().toLocaleString(),
                        "text-anchor": "start",
                        "font-size": Math.round(bubble.height() * 0.14, 1)
                    }
                ];

            d3.select("#bubble-chart > svg")
              .selectAll("text.stats")
            .data(texts).enter()
              .append("text")
                .classed("stats", true)
                .style("font-size", d => d["font-size"])
                .text(d => d.content)
                .attr("id", d => d.id)
                .attr("x", d => d.x)
                .attr("y", d => d.y)
                .attr("text-anchor", d => d["text-anchor"]);

            // const svg = d3.select("#sun-burst > svg");
            // const width = svg.node().getBoundingClientRect().width;
            // const height = svg.node().getBoundingClientRect().height;
            // const sunBurstG = d3.select("#sun-burst > svg > g");

            // const sunBurstZoom = d3.zoom().scaleExtent([1, 10]).on("zoom.sunburst", function() {
            //     svg.attr("viewBox","" + (-width / 2) + " " + (-height / 2) + " " + width + " " + height);
            //     return sunBurstG.attr("transform", d3.event.transform);
            // });

            // svg.call(sunBurstZoom);

            function sumUpdater() {
                //update the sum text
                d3.select("#sum").html( '$'+sumofAllExpends.value().toLocaleString() );
            };
        };

    //--------------- W3 Schools Helper Functions 
    function w3_open() {
        document.getElementById("main").style.marginLeft = "42.8%";
        document.getElementById("mySidebar").style.width = "41%";
        document.getElementById("mySidebar").style.height = "92%";
        document.getElementById("mySidebar").style.display = "block";
    };

    function w3_close() {
        document.getElementById("main").style.marginLeft = "0%";
        document.getElementById("mySidebar").style.display = "none";
        document.getElementById("openNav").style.display = "inline-block";
    };

    function myAccFunc(id) {
        const x = document.getElementById(id);
        if (x.className.indexOf("w3-show") == -1) {
            x.className += " w3-show";
            x.previousElementSibling.className += " w3-darkblue";
        } else { 
            x.className = x.className.replace(" w3-show", "");
            x.previousElementSibling.className = 
            x.previousElementSibling.className.replace(" w3-darkblue", "");
        }
    };
    //--------------- W3 Schools Helper Functions 
</script>
</body>
</html>
